name: .NET Publish

on:
  push:
    tags:
      - '*'

jobs:
  build:
    strategy:
      matrix:
        release:
          - { os: windows-latest, arch: win-x86 }
          - { os: windows-latest, arch: win-x64 }
          - { os: ubuntu-latest, arch: linux-x64 }
        
    runs-on: ${{ matrix.release.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Execute unit tests
      run: dotnet test

    - name: Restore the application
      run: dotnet restore
      
    - name: Build
      run: |
        cd OsuPlayer
        dotnet publish -c Release -o ../releases/${{ matrix.release.arch }} -r ${{ matrix.release.arch }}
    
    - name: Generate artifact
      uses: TheDoctor0/zip-release@0.6.1
      with:
        type: 'zip'
        filename: '${{ matrix.release.arch }}.zip'
        directory: 'releases/${{ matrix.release.arch }}' 
    
    - name: Publish Artifact
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true
        artifacts: 'releases/${{ matrix.release.arch }}/${{ matrix.release.arch }}.zip'
        token: ${{ secrets.GITHUB_TOKEN }}