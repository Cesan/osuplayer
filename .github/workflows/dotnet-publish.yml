name: .NET Publish

on:
  push:
    tags:
      - '*'

jobs:
  setup:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        generateReleaseNotes: true
        omitPrereleaseDuringUpdate: true

  build:
    needs: setup
    name: Publish ${{ matrix.release.arch }}
    strategy:
      matrix:
        release:
          - { os: windows-latest, arch: win-x86 }
          - { os: windows-latest, arch: win-x64 }
          - { os: ubuntu-latest, arch: linux-x64 }
          - { os: macos-latest, arch: osx-x64 }
        
    runs-on: ${{ matrix.release.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
     
    - name: Get tag name
      id: get_tag
      run: echo ::set-output name=TAG::${GITHUB_REF#refs/tags/}
      shell: bash

    - name: Install .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Execute unit tests
      run: dotnet test

    - name: Restore the application
      run: dotnet restore
      
    - name: Build
      env:
        RELEASE_VERSION: ${{ steps.get_tag.outputs.TAG }}
      run: |
        cd OsuPlayer
        dotnet publish -c Release -o ../releases/${{ matrix.release.arch }} -r ${{ matrix.release.arch }}
    
    - name: Generate artifact
      uses: TheDoctor0/zip-release@0.6.1
      with:
        type: 'zip'
        filename: '${{ matrix.release.arch }}.zip'
        directory: 'releases/${{ matrix.release.arch }}' 
    
    - name: Publish Artifact
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        omitPrereleaseDuringUpdate: true
        artifacts: 'releases/${{ matrix.release.arch }}/${{ matrix.release.arch }}.zip'
        token: ${{ secrets.GITHUB_TOKEN }}